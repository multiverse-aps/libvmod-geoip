#!/bin/bash

readonly srcname=libvmod-geoip
readonly pkgname=varnish-geoip

set -e

case "$1" in
clean)
  git clean -fdx
  ;;

build)
  startdir="$(pwd)"

  version="$(git describe --tags HEAD^)"
  version="${version#$srcname-}"
  version="${version//-/.}"

  name="$DEBFULLNAME"
  if [[ -z "$name" ]]; then
    name="$(getent passwd "$USER")"
    name="${name#*:*:*:*:}"
    name="${name%%:*}"
  fi
  [[ -n "$name" ]] || name="$USER"
  [[ -n "$name" ]] || name='Unknown'

  email="$DEBEMAIL"
  [[ -n "$email" || -z "$USER" ]] || email="${USER}@$(hostname -f)"
  [[ -n "$email" ]] || email="unknown@$(hostname -f)"

  date="$(LC_ALL=C date '+%a, %d %b %Y %T %z')"

  os_pretty_name="$(. /etc/os-release; echo "$PRETTY_NAME")"
  case "$(. /etc/os-release; echo "${ID}-${VERSION_ID}")" in
  debian-9) suite=stretch;;
  *)        suite=unknown;;
  esac

  {
    echo "$srcname ($version) $suite; urgency=low"
    echo
    echo "  * Autogenerated release build for $os_pretty_name."
    echo
    echo " -- $name <$email>  $date"
  } > debian/changelog

  ./autogen.sh
  ./configure --datarootdir=/usr/share
  make
  ;;

binary)
  depends='varnish, libgeoip1'
  startdir="$(pwd)"
  pkgdir="$startdir/debian/tmp"

  install -dm755 "$pkgdir"
  install -dm755 "$pkgdir/DEBIAN"

  make DESTDIR="$pkgdir" install
  find "$pkgdir" -name '*.la' -delete
  [[ "$srcname" = "$pkgname" ]] || \
    mv "$pkgdir/usr/share/doc/$srcname" "$pkgdir/usr/share/doc/$pkgname"

  dpkg-gencontrol -V"dist:depends=$depends"
  dpkg-deb -b "$pkgdir" ..
  ;;
esac

# vim: set ts=2 sw=2 et:
